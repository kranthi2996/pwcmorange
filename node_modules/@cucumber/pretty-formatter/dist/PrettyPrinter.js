"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PrettyPrinter = void 0;
const messages_1 = require("@cucumber/messages");
const query_1 = require("@cucumber/query");
const formatting_1 = require("./formatting");
const SummaryPrinter_1 = require("./SummaryPrinter");
const theme_1 = require("./theme");
const utils_1 = require("./utils");
const DEFAULT_OPTIONS = {
    includeAttachments: true,
    includeFeatureLine: true,
    includeRuleLine: true,
    summarise: false,
    useStatusIcon: true,
    theme: theme_1.CUCUMBER_THEME,
};
/**
 * Prints test progress in a prettified Gherkin-style format
 *
 * @remarks
 * Outputs features, rules, scenarios, and steps with proper indentation and styling.
 * Shows step results, attachments, and error details as tests execute. This is the
 * primary formatter for readable console output during test runs.
 */
class PrettyPrinter {
    stream;
    print;
    println;
    options;
    query = new query_1.Query();
    scenarioIndentByTestCaseStartedId = new Map();
    maxContentLengthByTestCaseStartedId = new Map();
    encounteredFeaturesAndRules = new Set();
    /**
     * Creates a new PrettyPrinter instance
     *
     * @param params -Initialisation object
     * @param params.stream - The writable stream used for TTY detection and styling
     * @param params.options - Configuration options for the pretty output
     */
    constructor({ stream = process.stdout, options = {}, } = {}) {
        this.stream = stream;
        this.print = (content) => stream.write(content);
        this.println = (content = '') => this.print(`${content}\n`);
        this.options = {
            ...DEFAULT_OPTIONS,
            ...options,
        };
    }
    /**
     * Processes a Cucumber message envelope and prints if appropriate
     *
     * @param message - The Cucumber message envelope to process
     */
    update(message) {
        this.query.update(message);
        if (message.testCaseStarted) {
            this.preCalculateIndentAndMaxContentLength(message.testCaseStarted);
            this.handleTestCaseStarted(message.testCaseStarted);
        }
        if (message.attachment) {
            this.handleAttachment(message.attachment);
        }
        if (message.testStepFinished) {
            this.handleTestStepFinished(message.testStepFinished);
        }
        if (message.testRunFinished) {
            this.handleTestRunFinished(message.testRunFinished);
        }
    }
    summarise() {
        SummaryPrinter_1.SummaryPrinter.summarise(this.query, {
            stream: this.stream,
            options: this.options,
        });
    }
    resolveScenario(testCaseStarted) {
        const pickle = (0, utils_1.ensure)(this.query.findPickleBy(testCaseStarted), 'Pickle must exist for TestCaseStarted');
        const location = this.query.findLocationOf(pickle);
        const lineage = (0, utils_1.ensure)(this.query.findLineageBy(pickle), 'Lineage must exist for Pickle');
        const scenario = (0, utils_1.ensure)(lineage.scenario, 'Scenario must exist for Lineage');
        const rule = lineage.rule;
        const feature = (0, utils_1.ensure)(lineage.feature, 'Feature must exist for Lineage');
        return {
            pickle,
            location,
            scenario,
            rule,
            feature,
        };
    }
    resolveStep(testStepFinished) {
        const testStep = (0, utils_1.ensure)(this.query.findTestStepBy(testStepFinished), 'TestStep must exist for TestStepFinished');
        const pickleStep = this.query.findPickleStepBy(testStep);
        if (!pickleStep) {
            return undefined;
        }
        const step = (0, utils_1.ensure)(this.query.findStepBy(pickleStep), 'Step must exist for PickleStep');
        const stepDefinition = this.query.findUnambiguousStepDefinitionBy(testStep);
        return {
            testStep,
            pickleStep,
            step,
            stepDefinition,
        };
    }
    preCalculateIndentAndMaxContentLength(testCaseStarted) {
        const pickle = (0, utils_1.ensure)(this.query.findPickleBy(testCaseStarted), 'Pickle must exist for TestCaseStarted');
        const lineage = (0, utils_1.ensure)(this.query.findLineageBy(pickle), 'Lineage must exist for Pickle');
        const scenario = (0, utils_1.ensure)(lineage.scenario, 'Scenario must exist for Lineage');
        const scenarioLength = (0, utils_1.unstyled)((0, formatting_1.formatPickleTitle)(pickle, scenario, this.options.theme, this.stream)).length;
        const testCase = (0, utils_1.ensure)(this.query.findTestCaseBy(testCaseStarted), 'TestCase must exist for TestCaseStarted');
        const stepLengths = testCase.testSteps
            .filter((testStep) => !!testStep.pickleStepId)
            .map((testStep) => {
            const pickleStep = (0, utils_1.ensure)(this.query.findPickleStepBy(testStep), 'PickleStep must exist for TestStep');
            const step = (0, utils_1.ensure)(this.query.findStepBy(pickleStep), 'Step must exist for PickleStep');
            return (0, utils_1.indent)((0, utils_1.unstyled)((0, formatting_1.formatStepTitle)(testStep, pickleStep, step, messages_1.TestStepResultStatus.UNKNOWN, this.options.useStatusIcon, this.options.theme, this.stream)), utils_1.GHERKIN_INDENT_LENGTH).length;
        });
        this.maxContentLengthByTestCaseStartedId.set(testCaseStarted.id, Math.max(scenarioLength, ...stepLengths));
        let scenarioIndent = 0;
        if (this.options.includeFeatureLine) {
            scenarioIndent += utils_1.GHERKIN_INDENT_LENGTH;
            if (this.options.includeRuleLine && lineage.rule) {
                scenarioIndent += utils_1.GHERKIN_INDENT_LENGTH;
            }
        }
        this.scenarioIndentByTestCaseStartedId.set(testCaseStarted.id, scenarioIndent);
    }
    getScenarioIndentBy(by) {
        if ('testCaseStartedId' in by && by.testCaseStartedId) {
            return this.scenarioIndentByTestCaseStartedId.get(by.testCaseStartedId) ?? 0;
        }
        else if ('testCaseId' in by) {
            return this.scenarioIndentByTestCaseStartedId.get(by.id) ?? 0;
        }
        return 0;
    }
    getMaxContentLengthBy(by) {
        if ('testCaseStartedId' in by) {
            return this.maxContentLengthByTestCaseStartedId.get(by.testCaseStartedId) ?? 0;
        }
        return this.maxContentLengthByTestCaseStartedId.get(by.id) ?? 0;
    }
    handleTestCaseStarted(testCaseStarted) {
        const { pickle, location, scenario, rule, feature } = this.resolveScenario(testCaseStarted);
        const scenarioIndent = this.getScenarioIndentBy(testCaseStarted);
        const maxContentLength = this.getMaxContentLengthBy(testCaseStarted);
        this.printFeatureLine(feature);
        this.printRuleLine(rule);
        this.println();
        this.printTags(pickle, scenarioIndent);
        this.printScenarioLine(pickle, scenario, location, scenarioIndent, maxContentLength);
    }
    printFeatureLine(feature) {
        if (this.options.includeFeatureLine && !this.encounteredFeaturesAndRules.has(feature)) {
            this.println();
            this.println((0, formatting_1.formatFeatureTitle)(feature, this.options.theme, this.stream));
        }
        this.encounteredFeaturesAndRules.add(feature);
    }
    printRuleLine(rule) {
        if (rule) {
            if (this.options.includeRuleLine && !this.encounteredFeaturesAndRules.has(rule)) {
                this.println();
                this.println((0, utils_1.indent)((0, formatting_1.formatRuleTitle)(rule, this.options.theme, this.stream), utils_1.GHERKIN_INDENT_LENGTH));
            }
            this.encounteredFeaturesAndRules.add(rule);
        }
    }
    printTags(pickle, scenarioIndent) {
        if (pickle.tags.length > 0) {
            this.println((0, utils_1.indent)((0, formatting_1.formatTags)(pickle.tags, this.options.theme, this.stream), scenarioIndent));
        }
    }
    printScenarioLine(pickle, scenario, location, scenarioIndent, maxContentLength) {
        this.printGherkinLine((0, formatting_1.formatPickleTitle)(pickle, scenario, this.options.theme, this.stream), (0, formatting_1.formatPickleLocation)(pickle, location, this.options.theme, this.stream), scenarioIndent, maxContentLength);
    }
    handleTestStepFinished(testStepFinished) {
        const scenarioIndent = this.getScenarioIndentBy(testStepFinished);
        const maxContentLength = this.getMaxContentLengthBy(testStepFinished);
        const resolved = this.resolveStep(testStepFinished);
        if (resolved) {
            const { testStep, pickleStep, step, stepDefinition } = resolved;
            this.printStepLine(testStepFinished, testStep, pickleStep, step, stepDefinition, scenarioIndent, maxContentLength);
            this.printStepArgument(pickleStep, scenarioIndent);
            this.printAmbiguousStep(testStepFinished, testStep, scenarioIndent);
        }
        this.printError(testStepFinished, scenarioIndent);
    }
    printStepLine(testStepFinished, testStep, pickleStep, step, stepDefinition, scenarioIndent, maxContentLength) {
        this.printGherkinLine((0, utils_1.indent)((0, formatting_1.formatStepTitle)(testStep, pickleStep, step, testStepFinished.testStepResult.status, this.options.useStatusIcon, this.options.theme, this.stream), utils_1.GHERKIN_INDENT_LENGTH), stepDefinition?.sourceReference
            ? (0, formatting_1.formatSourceReference)(stepDefinition.sourceReference, this.options.theme, this.stream)
            : undefined, scenarioIndent, maxContentLength);
    }
    printStepArgument(pickleStep, scenarioIndent) {
        if (pickleStep.argument) {
            this.println((0, utils_1.indent)((0, formatting_1.formatPickleStepArgument)(pickleStep.argument, this.options.theme, this.stream), scenarioIndent +
                (this.options.useStatusIcon ? utils_1.GHERKIN_INDENT_LENGTH : 0) +
                utils_1.GHERKIN_INDENT_LENGTH +
                utils_1.STEP_ARGUMENT_INDENT_LENGTH));
        }
    }
    printGherkinLine(title, location, indentBy, maxContentLength) {
        let output = title;
        if (location) {
            const padding = maxContentLength - (0, utils_1.unstyled)(title).length;
            output += (0, utils_1.indent)(location, padding + 1);
        }
        this.println((0, utils_1.indent)(output, indentBy));
    }
    printError(testStepFinished, scenarioIndent) {
        const error = testStepFinished.testStepResult.exception?.stackTrace ||
            testStepFinished.testStepResult.exception?.message ||
            testStepFinished.testStepResult.message;
        if (error) {
            const content = (0, formatting_1.formatError)(error, testStepFinished.testStepResult.status, this.options.theme, this.stream);
            this.println((0, utils_1.indent)(content, scenarioIndent +
                (this.options.useStatusIcon ? utils_1.GHERKIN_INDENT_LENGTH : 0) +
                utils_1.GHERKIN_INDENT_LENGTH +
                utils_1.ERROR_INDENT_LENGTH));
        }
    }
    printAmbiguousStep(testStepFinished, testStep, scenarioIndent) {
        if (testStepFinished.testStepResult.status === messages_1.TestStepResultStatus.AMBIGUOUS) {
            const content = (0, formatting_1.formatAmbiguousStep)(this.query.findStepDefinitionsBy(testStep), this.options.theme, this.stream);
            if (content) {
                this.println((0, utils_1.indent)(content, scenarioIndent +
                    (this.options.useStatusIcon ? utils_1.GHERKIN_INDENT_LENGTH : 0) +
                    utils_1.GHERKIN_INDENT_LENGTH +
                    utils_1.ERROR_INDENT_LENGTH));
            }
        }
    }
    handleAttachment(attachment) {
        if (!this.options.includeAttachments) {
            return;
        }
        const scenarioIndent = this.getScenarioIndentBy(attachment);
        const content = (0, formatting_1.formatAttachment)(attachment, this.options.theme, this.stream);
        this.println((0, utils_1.pad)((0, utils_1.indent)(content, scenarioIndent +
            (this.options.useStatusIcon ? utils_1.GHERKIN_INDENT_LENGTH : 0) +
            utils_1.GHERKIN_INDENT_LENGTH +
            utils_1.ATTACHMENT_INDENT_LENGTH)));
    }
    handleTestRunFinished(testRunFinished) {
        const error = testRunFinished.exception?.stackTrace || testRunFinished.exception?.message;
        if (error) {
            this.println((0, formatting_1.formatError)(error, messages_1.TestStepResultStatus.FAILED, this.options.theme, this.stream));
        }
        if (this.options.summarise) {
            this.summarise();
        }
    }
}
exports.PrettyPrinter = PrettyPrinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJldHR5UHJpbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9QcmV0dHlQcmludGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlEQWdCMkI7QUFDM0IsMkNBQXVDO0FBRXZDLDZDQVlxQjtBQUNyQixxREFBaUQ7QUFDakQsbUNBQXdDO0FBRXhDLG1DQVNnQjtBQUVoQixNQUFNLGVBQWUsR0FBNEI7SUFDL0Msa0JBQWtCLEVBQUUsSUFBSTtJQUN4QixrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLGVBQWUsRUFBRSxJQUFJO0lBQ3JCLFNBQVMsRUFBRSxLQUFLO0lBQ2hCLGFBQWEsRUFBRSxJQUFJO0lBQ25CLEtBQUssRUFBRSxzQkFBYztDQUN0QixDQUFBO0FBRUQ7Ozs7Ozs7R0FPRztBQUNILE1BQWEsYUFBYTtJQUNQLE1BQU0sQ0FBdUI7SUFDN0IsS0FBSyxDQUEyQjtJQUNoQyxPQUFPLENBQTRCO0lBQ25DLE9BQU8sQ0FBeUI7SUFDaEMsS0FBSyxHQUFVLElBQUksYUFBSyxFQUFFLENBQUE7SUFDMUIsaUNBQWlDLEdBQXdCLElBQUksR0FBRyxFQUc5RSxDQUFBO0lBQ2MsbUNBQW1DLEdBQXdCLElBQUksR0FBRyxFQUdoRixDQUFBO0lBQ2MsMkJBQTJCLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUE7SUFFN0U7Ozs7OztPQU1HO0lBQ0gsWUFBWSxFQUNWLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUN2QixPQUFPLEdBQUcsRUFBRSxNQUlWLEVBQUU7UUFDSixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtRQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQy9DLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxPQUFPLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFD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