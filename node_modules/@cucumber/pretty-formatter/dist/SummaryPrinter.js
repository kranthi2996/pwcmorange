"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SummaryPrinter = void 0;
const messages_1 = require("@cucumber/messages");
const query_1 = require("@cucumber/query");
const composition_1 = require("./composition");
const formatting_1 = require("./formatting");
const queries_1 = require("./queries");
const theme_1 = require("./theme");
const utils_1 = require("./utils");
const DEFAULT_OPTIONS = {
    includeAttachments: true,
    theme: theme_1.CUCUMBER_THEME,
};
/**
 * Prints a summary of test results including non-passing scenarios, statistics, and snippets
 *
 * @remarks
 * Outputs non-passing scenarios and hooks, scenario and step counts, durations, and suggested
 * snippets for undefined steps.
 */
class SummaryPrinter {
    stream;
    print;
    println;
    options;
    query = new query_1.Query();
    /**
     * Creates a new SummaryPrinter instance
     *
     * @param params - Initialisation object
     * @param params.stream - The stream being written to, used for feature detection
     * @param params.options - Options for the output
     */
    constructor({ stream = process.stdout, options = {}, } = {}) {
        this.stream = stream;
        this.print = (content) => stream.write(content);
        this.println = (content = '') => this.print(`${content}\n`);
        this.options = {
            ...DEFAULT_OPTIONS,
            ...options,
        };
    }
    /**
     * Processes a Cucumber message envelope and prints if appropriate
     *
     * @param envelope - The Cucumber message envelope to process
     */
    update(envelope) {
        this.query.update(envelope);
        if (envelope.testRunFinished) {
            this.printSummary();
        }
    }
    /**
     * Immediately print a summary from pre-populated Query object
     *
     * @param query - A pre-populated Query object to be summarised
     * @param params - See constructor
     */
    static summarise(query, { stream = process.stdout, options = {}, } = {}) {
        const printer = new SummaryPrinter({
            stream,
            options,
        });
        printer.query = query;
        printer.printSummary();
    }
    printSummary() {
        this.printNonPassingScenarios();
        this.printUnknownParameterTypes();
        this.printNonPassingGlobalHooks();
        this.printNonPassingTestRun();
        this.printStats();
        this.printSnippets();
    }
    printStats() {
        this.println();
        this.println((0, composition_1.composeStats)(this.query, this.options.theme, this.stream));
    }
    printNonPassingScenarios() {
        const nonPassingScenarios = this.resolveNonPassingScenarios();
        for (const status of utils_1.ORDERED_STATUSES) {
            const forThisStatus = nonPassingScenarios.get(status) ?? [];
            if (forThisStatus.length > 0) {
                this.println();
                this.println((0, formatting_1.formatForStatus)(status, `${(0, formatting_1.formatStatusName)(status)} scenarios:`, this.options.theme, this.stream));
                forThisStatus.forEach((testCaseFinished, index) => {
                    const formatted = (0, composition_1.composeScenarioSummary)(testCaseFinished, this.query, this.options, this.stream);
                    this.println((0, utils_1.indentNumbered)(formatted, 2, index + 1));
                });
            }
        }
    }
    resolveNonPassingScenarios() {
        const reportableByStatus = new Map();
        for (const testCaseFinished of (0, queries_1.findAllTestCaseFinishedInCanonicalOrder)(this.query)) {
            const mostSevereResult = this.query.findMostSevereTestStepResultBy(testCaseFinished);
            if (mostSevereResult && !utils_1.NON_REPORTABLE_STATUSES.includes(mostSevereResult.status)) {
                if (!reportableByStatus.has(mostSevereResult.status)) {
                    reportableByStatus.set(mostSevereResult.status, []);
                }
                reportableByStatus.get(mostSevereResult.status)?.push(testCaseFinished);
            }
        }
        return reportableByStatus;
    }
    printUnknownParameterTypes() {
        const unknownParameterTypes = this.query.findAllUndefinedParameterTypes();
        if (unknownParameterTypes.length > 0) {
            this.println();
            this.println((0, formatting_1.formatForStatus)(messages_1.TestStepResultStatus.UNDEFINED, 'These parameters are missing a parameter type definition:', this.options.theme, this.stream));
            unknownParameterTypes.forEach((upt, index) => {
                this.println((0, utils_1.indentNumbered)((0, formatting_1.formatUndefinedParameterType)(upt), utils_1.GHERKIN_INDENT_LENGTH, index + 1));
            });
        }
    }
    printNonPassingGlobalHooks() {
        const testRunHookFinished = this.query.findAllTestRunHookFinished();
        const failedHooks = testRunHookFinished.filter((hook) => hook.result.status === messages_1.TestStepResultStatus.FAILED);
        if (failedHooks.length > 0) {
            this.println();
            this.println((0, formatting_1.formatForStatus)(messages_1.TestStepResultStatus.FAILED, `${(0, formatting_1.formatStatusName)(messages_1.TestStepResultStatus.FAILED)} hooks:`, this.options.theme, this.stream));
            failedHooks.forEach((testRunHookFinished, index) => {
                const formatted = (0, composition_1.composeGlobalHookSummary)(testRunHookFinished, this.query, this.options, this.stream);
                this.println((0, utils_1.indentNumbered)(formatted, utils_1.GHERKIN_INDENT_LENGTH, index + 1));
            });
        }
    }
    printNonPassingTestRun() {
        const testRunFinished = this.query.findTestRunFinished();
        if (testRunFinished?.exception) {
            this.println((0, formatting_1.formatForStatus)(messages_1.TestStepResultStatus.FAILED, `${(0, formatting_1.formatStatusName)(messages_1.TestStepResultStatus.FAILED)} test run:`, this.options.theme, this.stream));
            const error = testRunFinished.exception?.stackTrace || testRunFinished.exception?.message;
            if (error) {
                this.print((0, utils_1.indent)((0, formatting_1.formatError)(error, messages_1.TestStepResultStatus.FAILED, this.options.theme, this.stream), 7));
            }
        }
    }
    printSnippets() {
        const suggestions = (0, queries_1.findAllSuggestions)(this.query);
        if (suggestions.length > 0) {
            this.println((0, composition_1.composeSnippets)(suggestions));
        }
    }
}
exports.SummaryPrinter = SummaryPrinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3VtbWFyeVByaW50ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvU3VtbWFyeVByaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBQXFGO0FBQ3JGLDJDQUF1QztBQUV2QywrQ0FLc0I7QUFDdEIsNkNBS3FCO0FBQ3JCLHVDQUF1RjtBQUN2RixtQ0FBd0M7QUFFeEMsbUNBTWdCO0FBRWhCLE1BQU0sZUFBZSxHQUE2QjtJQUNoRCxrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLEtBQUssRUFBRSxzQkFBYztDQUN0QixDQUFBO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsTUFBYSxjQUFjO0lBQ1IsTUFBTSxDQUF1QjtJQUM3QixLQUFLLENBQTJCO0lBQ2hDLE9BQU8sQ0FBNEI7SUFDbkMsT0FBTyxDQUEwQjtJQUMxQyxLQUFLLEdBQVUsSUFBSSxhQUFLLEVBQUUsQ0FBQTtJQUVsQzs7Ozs7O09BTUc7SUFDSCxZQUFZLEVBQ1YsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQ3ZCLE9BQU8sR0FBRyxFQUFFLE1BSVYsRUFBRTtRQUNKLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLE9BQU8sR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxPQUFPLElBQUksQ0FBQyxDQUFBO1FBQzNELElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixHQUFHLGVBQWU7WUFDbEIsR0FBRyxPQUFPO1NBQ1gsQ0FBQTtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksTUFBTSxDQUFDLFFBQWtCO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FB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