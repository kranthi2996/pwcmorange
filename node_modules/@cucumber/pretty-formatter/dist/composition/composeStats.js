"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.composeStats = composeStats;
const messages_1 = require("@cucumber/messages");
const formatting_1 = require("../formatting");
function composeStats(query, theme, stream) {
    const lines = [];
    const testRunFinished = query.findTestRunFinished();
    if (testRunFinished?.exception) {
        lines.push('');
        lines.push((0, formatting_1.formatCounts)('test run', {
            [messages_1.TestStepResultStatus.FAILED]: 1,
        }, theme, stream));
    }
    const testRunHookFinished = query.findAllTestRunHookFinished();
    if (testRunHookFinished.length > 0) {
        const globalHookCountsByStatus = testRunHookFinished
            .map((hook) => hook.result.status)
            .reduce((prev, status) => {
            return {
                ...prev,
                [status]: (prev[status] ?? 0) + 1,
            };
        }, {});
        lines.push((0, formatting_1.formatCounts)('hooks', globalHookCountsByStatus, theme, stream));
    }
    const scenarioCountsByStatus = query
        .findAllTestCaseFinished()
        .map((testCaseFinished) => query.findMostSevereTestStepResultBy(testCaseFinished))
        .map((testStepResult) => testStepResult?.status ?? messages_1.TestStepResultStatus.PASSED)
        .reduce((prev, status) => {
        return {
            ...prev,
            [status]: (prev[status] ?? 0) + 1,
        };
    }, {});
    lines.push((0, formatting_1.formatCounts)('scenarios', scenarioCountsByStatus, theme, stream));
    const stepCountsByStatus = query
        .findAllTestCaseFinished()
        .flatMap((testCaseFinished) => query.findTestStepsFinishedBy(testCaseFinished))
        .map((testStepFinished) => testStepFinished.testStepResult.status)
        .reduce((prev, status) => {
        return {
            ...prev,
            [status]: (prev[status] ?? 0) + 1,
        };
    }, {});
    lines.push((0, formatting_1.formatCounts)('steps', stepCountsByStatus, theme, stream));
    const testRunDuration = query.findTestRunDuration();
    if (testRunDuration) {
        const testRunHookDurations = query
            .findAllTestRunHookFinished()
            .map((hookFinished) => hookFinished.result.duration);
        const testStepDurations = query
            .findAllTestStepFinished()
            .map((stepFinished) => stepFinished.testStepResult.duration);
        const executionDurations = [...testRunHookDurations, ...testStepDurations];
        lines.push((0, formatting_1.formatDurations)(testRunDuration, executionDurations));
    }
    return lines.join('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9zZVN0YXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbXBvc2l0aW9uL2NvbXBvc2VTdGF0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQU1BLG9DQTZFQztBQW5GRCxpREFBeUQ7QUFHekQsOENBQTZEO0FBRzdELFNBQWdCLFlBQVksQ0FBQyxLQUFZLEVBQUUsS0FBWSxFQUFFLE1BQTZCO0lBQ3BGLE1BQU0sS0FBSyxHQUFrQixFQUFFLENBQUE7SUFFL0IsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLG1CQUFtQixFQUFFLENBQUE7SUFDbkQsSUFBSSxlQUFlLEVBQUUsU0FBUyxFQUFFLENBQUM7UUFDL0IsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNkLEtBQUssQ0FBQyxJQUFJLENBQ1IsSUFBQSx5QkFBWSxFQUNWLFVBQVUsRUFDVjtZQUNFLENBQUMsK0JBQW9CLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztTQUNqQyxFQUNELEtBQUssRUFDTCxNQUFNLENBQ1AsQ0FDRixDQUFBO0lBQ0gsQ0FBQztJQUVELE1BQU0sbUJBQW1CLEdBQUcsS0FBSyxDQUFDLDBCQUEwQixFQUFFLENBQUE7SUFDOUQsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDbkMsTUFBTSx3QkFBd0IsR0FBRyxtQkFBbUI7YUFDakQsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNqQyxNQUFNLENBQ0wsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDZixPQUFPO2dCQUNMLEdBQUcsSUFBSTtnQkFDUCxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7YUFDbEMsQ0FBQTtRQUNILENBQUMsRUFDRCxFQUFtRCxDQUNw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