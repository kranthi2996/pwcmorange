"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.composeScenarioSummary = composeScenarioSummary;
const messages_1 = require("@cucumber/messages");
const formatting_1 = require("../formatting");
const utils_1 = require("../utils");
const ERROR_INDENT_LENGTH = 4;
const ATTACHMENT_INDENT_LENGTH = 4;
function composeScenarioSummary(testCaseFinished, query, { includeAttachments, theme }, stream) {
    const testCaseStarted = (0, utils_1.ensure)(query.findTestCaseStartedBy(testCaseFinished), 'TestCaseStarted must exist for TestCaseFinished');
    const pickle = (0, utils_1.ensure)(query.findPickleBy(testCaseFinished), 'Pickle must exist for TestCaseFinished');
    const location = query.findLocationOf(pickle);
    const status = query.findMostSevereTestStepResultBy(testCaseFinished)?.status ?? messages_1.TestStepResultStatus.UNKNOWN;
    const [testStepFinished, testStep] = (0, utils_1.ensure)(query
        .findTestStepFinishedAndTestStepBy(testCaseStarted)
        .find(([tsf]) => tsf.testStepResult.status === status), 'Responsible step must exist for non-passing scenario');
    const lines = [];
    const formattedLocation = (0, formatting_1.formatPickleLocation)(pickle, location, theme, stream);
    const formattedAttempt = testCaseStarted.attempt > 0 ? `, after ${testCaseStarted.attempt + 1} attempts` : '';
    lines.push(`${pickle.name}${formattedAttempt} ${formattedLocation}`);
    if (testStep.pickleStepId) {
        const pickleStep = (0, utils_1.ensure)(query.findPickleStepBy(testStep), 'PickleStep must exist for Step with pickleStepId');
        const step = (0, utils_1.ensure)(query.findStepBy(pickleStep), 'Step must exist for PickleStep');
        const stepDefinition = query.findUnambiguousStepDefinitionBy(testStep);
        lines.push((0, utils_1.indent)((0, utils_1.join)((0, formatting_1.formatStepTitle)(testStep, pickleStep, step, status, false, theme, stream), stepDefinition?.sourceReference
            ? (0, formatting_1.formatSourceReference)(stepDefinition.sourceReference, theme, stream)
            : undefined), utils_1.GHERKIN_INDENT_LENGTH));
        if (pickleStep.argument) {
            lines.push((0, utils_1.indent)((0, formatting_1.formatPickleStepArgument)(pickleStep.argument, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + utils_1.STEP_ARGUMENT_INDENT_LENGTH));
        }
        if (status === messages_1.TestStepResultStatus.AMBIGUOUS) {
            const stepDefinitions = query.findStepDefinitionsBy(testStep);
            lines.push((0, utils_1.indent)((0, formatting_1.formatAmbiguousStep)(stepDefinitions, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ERROR_INDENT_LENGTH));
        }
    }
    else if (testStep.hookId) {
        const hook = query.findHookBy(testStep);
        lines.push((0, utils_1.indent)((0, utils_1.join)((0, formatting_1.formatHookTitle)(hook, status, theme, stream), hook?.sourceReference
            ? (0, formatting_1.formatSourceReference)(hook.sourceReference, theme, stream)
            : undefined), utils_1.GHERKIN_INDENT_LENGTH));
    }
    if (status === messages_1.TestStepResultStatus.FAILED) {
        const error = testStepFinished.testStepResult.exception?.stackTrace ||
            testStepFinished.testStepResult.exception?.message ||
            testStepFinished.testStepResult.message;
        if (error) {
            lines.push((0, utils_1.indent)((0, formatting_1.formatError)(error, status, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ERROR_INDENT_LENGTH));
        }
    }
    if (includeAttachments) {
        const attachments = query.findAttachmentsBy(testStepFinished);
        attachments.forEach((attachment) => {
            lines.push('');
            lines.push((0, utils_1.indent)((0, formatting_1.formatAttachment)(attachment, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ATTACHMENT_INDENT_LENGTH));
        });
    }
    return lines.join('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9zZVNjZW5hcmlvU3VtbWFyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb3NpdGlvbi9jb21wb3NlU2NlbmFyaW9TdW1tYXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBbUJBLHdEQStHQztBQWxJRCxpREFBMkU7QUFHM0UsOENBU3NCO0FBRXRCLG9DQUFtRztBQUVuRyxNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQTtBQUM3QixNQUFNLHdCQUF3QixHQUFHLENBQUMsQ0FBQTtBQUVsQyxTQUFnQixzQkFBc0IsQ0FDcEMsZ0JBQWtDLEVBQ2xDLEtBQVksRUFDWixFQUFFLGtCQUFrQixFQUFFLEtBQUssRUFBNEIsRUFDdkQsTUFBNkI7SUFFN0IsTUFBTSxlQUFlLEdBQUcsSUFBQSxjQUFNLEVBQzVCLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUM3QyxpREFBaUQsQ0FDbEQsQ0FBQTtJQUNELE1BQU0sTUFBTSxHQUFHLElBQUEsY0FBTSxFQUNuQixLQUFLLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQ3BDLHdDQUF3QyxDQUN6QyxDQUFBO0lBQ0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUM3QyxNQUFNLE1BQU0sR0FDVixLQUFLLENBQUMsOEJBQThCLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxNQUFNLElBQUksK0JBQW9CLENBQUMsT0FBTyxDQUFBO0lBQ2hHLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsR0FBRyxJQUFBLGNBQU0sRUFDekMsS0FBSztTQUNGLGlDQUFpQyxDQUFDLGVBQWUsQ0FBQztTQUNsRCxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsRUFDeEQsc0RBQXNELENBQ3ZELENBQUE7SUFF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